<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LAYOUT-DESIGNER</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
        
        <!-- Google Fonts einbinden -->
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
                }
            
            #main {
                display: flex;
                flex: 1;
                overflow: hidden;
                }

            #canvasSection {
                flex: 2;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #fafafa;
                border-right: 2px solid #ddd;
                padding: 20px;
                }

            #canvas-container {
                border: 2px solid black;
                background: white;
                }

            #toolPanel {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                background-color: #f4f4f4;
                }

            #toolbar {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                width: 220px;
                padding: 12px;
                background: #f8f8f8;
                border-left: 2px solid #ccc;
                box-shadow: -2px 0 5px rgba(0,0,0,0.05);
                font-family: Raleway, sans-serif;
                font-size: 14px;
                }

            .tool-section {
                margin-bottom: 18px;
                padding-bottom: 10px;
                border-bottom: 1px dashed #ddd;
                }

            .tool-section label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #444;
                }

                .tool-section button,
                .tool-section select,
                .tool-section input[type="number"],
                .tool-section input[type="color"] {
                width: 100%;
                margin: 3px 0;
                padding: 6px;
                box-sizing: border-box;
                }

            .save-actions {
                margin-top: auto;
                padding-top: 12px;
                border-top: 2px solid #999;
                }
    
            button, select, input {
                margin: 4px;
                padding: 6px;
                }

            select.intro-style {
                font-weight: bold;
                color: #444;
                border: 2px solid #ff9800;
                background-color: #fff8e1;
                box-shadow: 0 0 5px rgba(255, 152, 0, 0.6);
                transition: all 0.3s ease;
            }

            #layoutSelector.intro-style {
                border: 2px dashed #999;
                background-color: #f9f9f9;
                color: #666;
            }

            input.updated {
                animation: highlightFade 1s ease;
                background-color: #d4edda; /* leichtes gr√ºn */
                border: 1px solid #28a745;
            }

            #apiVariableEditor {
                margin-top: 20px;
            }

            @keyframes highlightFade {
            from {
                background-color: #d4edda;
            }
                to {
                    background-color: white;
                } 
            }

            @media (max-width: 768px) {
                body {
                    overflow-x: hidden;
                }
            
                #main {
                    flex-direction: column;
                }
            
                #canvasSection {
                    flex: none;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 10px;
                    height: 60vh; /* Gleichm√§√üiger Raum f√ºr Canvas */
                    min-height: 300px; /* verhindert zu kleine Fl√§chen */
                    border-right: none;
                    border-bottom: 2px solid #ddd;
                }
            
                #canvasSwipeWrapper {
                    position: relative;
                    overflow: hidden;
                    width: 100%;
                    max-width: 100%;
                    height: 100%;
                    display: flex;
                    justify-content: center;
                    align-items: center; /* vertikal zentriert */
                }
            
                #canvas-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    max-width: 100%;
                    max-height: 100%;
                    border: 2px solid #000;
                    background-color: rgba(255, 0, 0, 0.05); /* leicht rot f√ºr Test */
                    transition: transform 0.3s ease;
                    will-change: transform;
                }
            
                #toolPanel,
                #toolbar {
                    display: none !important;
                }

                /* üì¶ Bottom Sheet nur f√ºr Mobile */
                    
                #bottomSheet {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: auto;
                    max-height: 60px; /* Sichtbar wie angedockt */
                    background-color: #fff;
                    border-top: 2px solid #ccc;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                    overflow: hidden;
                    transition: max-height 0.3s ease;
                    z-index: 1000;
                    }

                #bottomSheet.expanded {
                    max-height: 75vh; /* Ge√∂ffnet: 75 % vom Bildschirm */
                    overflow-y: auto;
                    }

                #bottomSheetHandle {
                    width: 40px;
                    height: 5px;
                    background: #ccc;
                    border-radius: 5px;
                    margin: 8px auto;
                    }

                /* Optional: Verhindere Scrollen im Hintergrund */
                body.sheet-open {
                    overflow: hidden;
                }
                }


        </style>
    </head>
    
<body>
    <header style="padding: 10px; text-align: center; background-color: #222; color: white;">
        <h2>LAYOUT-DESIGNER</h2>
      </header>

      <div id="main">
        <!-- Canvas Section -->
        <div id="canvasSection">
            <div id="canvasSwipeWrapper">
                <div id="canvas-container">
                    <canvas id="canvas" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
        <div id="bottomSheet">
            <div id="bottomSheetHandle"></div>
            <div id="bottom-content">
              <!-- üëá Hier deine mobile Toolbar-Light rein -->
              <h4>üõ† Toolbar Light</h4>
              <label>Name 1: <input type="text" id="mobileName1"></label><br>
              <label>Name 2: <input type="text" id="mobileName2"></label><br>
              <label>Datum: <input type="text" id="mobileDate"></label><br>
              <button onclick="applyMobileVars()">üíæ √úbernehmen</button>
            </div>
          </div>
        <!-- Tool Panel -->
        <div id="toolPanel">
          <div>
            <span id="layoutNotice"><strong>Willkommen! W√§hle ein Layout, um zu starten:</strong></span><br><br>
            <select id="layoutSelector" onchange="changeLayout(this.value)"></select>
          </div>
    
          <div id="apiVariableEditor">
            <h3>Variablen bearbeiten</h3>
            <label>Name 1: <input type="text" id="varName1" value="SOPHIE"></label><br>
            <label>Name 2: <input type="text" id="varName2" value="MAX"></label><br>
            <label>Datum: <input type="text" id="varWeddingDate" value="12. M√§rz 2025"></label><br>
            <button onclick="updateVariables()">Variablen speichern</button>
          </div>
    
          <div id="toolbar">
            <div class="tool-section">
              <label for="fontFamily">Schriftart:</label>
              <select id="fontFamily" onchange="updateText('fontFamily', this.value)">
                <option value="Raleway">Raleway</option>
                <option value="Baskerville">Baskerville</option>
                <option value="Arial">Arial</option>
                <option value="Verdana">Verdana</option>
                <option value="Courier New">Courier</option>
                <option value="Georgia">Georgia</option>
              </select>
            </div>
          
            <div class="tool-section">
              <label for="fontSize">Gr√∂√üe:</label>
              <input type="number" id="fontSize" value="30" min="10" max="100" onchange="updateText('fontSize', this.value)">
            </div>
          
            <div class="tool-section">
              <label for="textColor">Farbe:</label>
              <input type="color" id="textColor" onchange="updateText('fill', this.value)">
            </div>
          
            <div class="tool-section">
              <label>Stil:</label>
              <button onclick="toggleBold()">B</button>
              <button onclick="toggleItalic()">I</button>
            </div>
          
            <div class="tool-section">
              <label>Ausrichtung:</label>
              <button onclick="setAlign('left')">‚¨Ö</button>
              <button onclick="setAlign('center')">üî≥</button>
              <button onclick="setAlign('right')">‚û°</button>
            </div>
          
            <div class="tool-section">
              <button id="textModeBtn">‚ûï Textfeld</button>
              <button onclick="deleteText()">üóë L√∂schen</button>
            </div>
          
            <div class="tool-section save-actions">
              <button onclick="saveLayoutToAPI(false)">üíæ Speichern</button>
              <button onclick="saveLayoutToAPI(true)">üöÄ Freigeben</button>
              <button id="exportBtn">üì§ PNG Export</button>
            </div>
          </div>
          
        </div>
      </div>

    <script>
        const layouts = [
    { id: 1, name: "Style 1 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style1.png", textGroups: [
            { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 84,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 450, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 103,  // Vertikale Position
                spacing: 15,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "‚Ä¢ weddingDate ‚Ä¢", size: 18, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 156,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 2, name: "Style 2 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style2.png", textGroups: [
            { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 282,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 18, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 18, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 18, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "‚Ä¢  weddingDate", size: 18, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 301,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 3, name: "Style 3 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style3.png", textGroups: [
            { groupId: "names1", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 127,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 27, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            { groupId: "and", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 133,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                texts: [
                    { text: "und", size: 18, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 200, fill: "#000000"}
                ]
            },
            { groupId: "names2", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 166,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                originY: "top",
                texts: [
                    { text: "name2", size: 27, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            { groupId: "date", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 215,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 155,  // Zentrum der Gruppe
                groupY: 370,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },
    
    { id: 4, name: "Style 4 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style4.png", textGroups: [
    { groupId: "names", 
                groupX: 166,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 72,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 230, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 20, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 20, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 20, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 166,  // Zentrum der Gruppe
                groupY: 96,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 166,  // Zentrum der Gruppe
                groupY: 161,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 5, name: "Style 5 - 10x15 - 6 Fotos", format: "10x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style5.png", textGroups: [
    { groupId: "names", 
                groupX: 200,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 463,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 350, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 200,  // Zentrum der Gruppe
                groupY: 490,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 14, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 200,  // Zentrum der Gruppe
                groupY: 560,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 6, name: "Style 6 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style6.png", textGroups: [
    { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 88,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 107,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 14, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 383,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 7, name: "Style 7 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style7.png", textGroups: [
    { groupId: "names", 
                groupX: 120,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 186,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 200, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 120,  // Zentrum der Gruppe
                groupY: 146,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "Erinnerungen f√ºr die Ewigkeit", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"} ,
                    { text: "|", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"} ,
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 120,  // Zentrum der Gruppe
                groupY: 206,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 8, name: "Style 8 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style8.png", textGroups: [
    { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 59,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 285, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 367,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS¬Æ", size: 10, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 9, name: "Style 9 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style9.png", textGroups: [
            {   groupId: "names1", 
                groupX: 68,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 77,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "name1", size: 21, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 68,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 124,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 100, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "&", size: 21, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 21, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 68,  // Zentrum der Gruppe
                groupY: 46,  // Vertikale Position
                spacing: 5,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 68,  // Zentrum der Gruppe
                groupY: 145,  // Vertikale Position
                spacing: 15,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 7, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 10, name: "Style 10 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style10.png", textGroups: [
            {   groupId: "names1", 
                groupX: 507,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 50,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 110, // Maximale Breite der Gruppe
                texts: [
                    { text: "name1", size: 20, fontFamily: "Raleway", charSpacing: 200, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 507,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 73,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 110, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 20, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 20, fontFamily: "Raleway", charSpacing: 200, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 507,  // Zentrum der Gruppe
                groupY: 103,  // Vertikale Position
                spacing: 5,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 507,  // Zentrum der Gruppe
                groupY: 159,  // Vertikale Position
                spacing: 15,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 11, name: "Style 11 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style11.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 160,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 285, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "‚Ä¢ name1", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2 ‚Ä¢", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 175,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS¬Æ", size: 10, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 12, name: "Style 12 - 15x5 - 3 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style12.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 18,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 400, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "‚Ä¢ name1", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 14, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2 ‚Ä¢", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 175,  // Vertikale Position
                spacing: 5,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "Ab jetzt - f√ºr immer |", size: 9, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"} ,
                    { text: "weddingDate", size: 9, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS¬Æ", size: 9, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 13, name: "Style 13 - 5x15 - 4 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style13.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 533,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 15, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 547,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 577,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 14, name: "Style 14 - 5x15 - 3 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style14.png", textGroups: [
    {   groupId: "names1", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 63,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 61,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 24, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 107,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 542,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 15, name: "Style 15 - 5x15 - 3 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style15.png", textGroups: [
    {   groupId: "names1", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 205,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 201,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 24, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 237,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "‚Ä¢ weddingDate ‚Ä¢", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 572,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 16, name: "Style 16 - 5x15 - 4 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style16.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 30,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 170, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "+", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 558,  // Vertikale Position
                spacing: 5,
                maxWidth: 80, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 574,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS¬Æ", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },
 ]

const canvas = new fabric.Canvas("canvas");
const DEBUG_MODE = false; // ‚¨ÖÔ∏è auf true setzen, wenn du testen willst

// üì± Bottom Sheet Handling
const bottomSheet = document.getElementById("bottomSheet");
const sheetHandle = document.getElementById("bottomSheetHandle");

canvas.selection = true; // Mehrfachauswahl durch Auswahlbox aktivieren
        
let textModeActive = false; // Standard: Kein neues Textfeld erstellen
let isProgrammaticLayoutChange = false; // Tempor√§re Sperre beim Initialaufbau des Layouts
let isSwipeInProgress = false;

 // üîπ Globale API-Variablen
const apiVariables = {
    name1: "ERIKA",
    name2: "MAX",
    weddingDate: "01. Januar 1978",
};

let canvasScaleX = 1;
let canvasScaleY = 1;
let logicalWidth = 600;  // neue Variable
let logicalHeight = 400; // neue Variable

let startY = 0;
let isDragging = false;

function isMobileView() {
  return window.innerWidth < 768;
}

function setCanvasSizeByFormat(format) {
    const canvasContainer = document.getElementById("canvas-container");
    const dpr = window.devicePixelRatio || 1;

    let displayWidth = 600;
    let displayHeight = 400;

    // üß† Definiere ‚Äûlogische Gr√∂√üe‚Äú abh√§ngig vom Format
    switch (format) {
        case "15x10":
            logicalWidth = 600;
            logicalHeight = 400;
            break;
        case "10x15":
            logicalWidth = 400;
            logicalHeight = 600;
            break;
        case "15x5":
            logicalWidth = 600;
            logicalHeight = 200;
            break;
        case "5x15":
            logicalWidth = 200;
            logicalHeight = 600;
            break;
    }

    displayWidth = logicalWidth;
    displayHeight = logicalHeight;

    if (window.innerWidth < 768) {
        displayWidth *= 0.5;
        displayHeight *= 0.5;
    }

    const renderWidth = displayWidth * dpr;
    const renderHeight = displayHeight * dpr;

    canvas.setWidth(renderWidth);
    canvas.setHeight(renderHeight);
    canvas.setDimensions({ width: displayWidth, height: displayHeight });

    canvasContainer.style.width = `${displayWidth}px`;
    canvasContainer.style.height = `${displayHeight}px`;

    // ‚¨ÖÔ∏è Jetzt korrekt auf Basis der "echten" Formatgr√∂√üe
    canvasScaleX = displayWidth / logicalWidth;
    canvasScaleY = displayHeight / logicalHeight;

    console.log(`üéØ Canvas-Gr√∂√üe: ${displayWidth}x${displayHeight} (Format: ${format})`);
}

function loadWelcomeCanvas() {
    canvas.clear();
    setCanvasSizeByFormat("15x10");

    const welcomeText = new fabric.IText(
        "üëã Willkommen beim Layout-Designer!\n\n‚û§ W√§hle oben ein Layout aus\n‚û§ Bearbeite Namen und Datum\n‚û§ F√ºge eigene Texte hinzu\n\nüé® Nutze die Werkzeugleiste unter dem Canvas!",
        {
            left: 80 * canvasScaleX,
            top: 80 * canvasScaleY,
            fontSize: 20 * canvasScaleY,
            fontFamily: "Raleway",
            fill: "#333",
            width: 450 * canvasScaleX,
            textAlign: "left",
            editable: false,
            selectable: false
        }
    );

    canvas.add(welcomeText);
    canvas.renderAll();

    const dropdown = document.getElementById("layoutSelector");
    dropdown.value = "";
    dropdown.classList.add("intro-style");

    dropdown.style.border = "2px dashed #888";
    dropdown.style.backgroundColor = "#f8f8f8";

    document.getElementById("layoutNotice").textContent = "Willkommen ‚Äì bitte w√§hle ein Layout:";
}

 
document.addEventListener("DOMContentLoaded", () => {
    populateDropdown();
    enableMobileSwipeWithAnimation();

    // ‚¨áÔ∏è NEU: Desktop-Toolbar bei Mobile ausblenden
    if (isMobileView()) {
        document.getElementById("toolPanel").style.display = "none";
        document.getElementById("toolbar").style.display = "none";
    }

    const layoutId = checkLayoutID();
    if (layoutId) {
        console.log("üîó Lade Layout aus API f√ºr ID:", layoutId);
        loadLayoutFromAPI(layoutId);
    }

    // ‚úÖ API-Werte direkt setzen, falls kein API-Call stattfindet
    setTimeout(() => {
        updateCanvasText();
    }, 300);
    
    // ‚úÖ NEU: Aktualisiere Dropdown-Stile beim Start
        updateDropdownStyles();
});

document.addEventListener("keydown", function(event) {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) return;

    // Falls das Textfeld gerade bearbeitet wird
    if (activeObject.isEditing) {
        if (event.key === "Enter") {
            activeObject.exitEditing();
            canvas.discardActiveObject();
            canvas.renderAll();
            document.getElementById("toolbar").style.display = "none";
            event.preventDefault();
        }
        return; // üîπ Falls bearbeitet wird, keine weiteren Aktionen ausf√ºhren
    }

    // Falls kein Bearbeitungsmodus aktiv ist
    if (event.key === "Delete" || event.key === "Backspace") {
        deleteText();
        event.preventDefault();
    }

    // Pfeiltasten: Nur wenn nicht im Edit-Modus
    if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(event.key)) {
        let step = event.shiftKey ? 10 : 1;
        
        if (event.key === "ArrowLeft") activeObject.set("left", activeObject.left - step);
        if (event.key === "ArrowRight") activeObject.set("left", activeObject.left + step);
        if (event.key === "ArrowUp") activeObject.set("top", activeObject.top - step);
        if (event.key === "ArrowDown") activeObject.set("top", activeObject.top + step);

        activeObject.setCoords();
        canvas.renderAll();
        
        // üîπ NEU: Zeigt die aktuelle Position in der Konsole an
        console.log(`Text: "${activeObject.text}" | X: ${Math.round(activeObject.left)}, Y: ${Math.round(activeObject.top)}`);

        event.preventDefault();
    }
});

function populateDropdown() {
    const dropdown = document.getElementById("layoutSelector");

    // üü° Willkommensoption ganz oben
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "üñê Noch kein Layout ausgew√§hlt";
    defaultOption.disabled = false;
    defaultOption.selected = true;
    dropdown.appendChild(defaultOption);

    // üîÑ Alle echten Layouts hinzuf√ºgen
    layouts.forEach(layout => {
        const option = document.createElement("option");
        option.value = layout.id;
        option.textContent = `${layout.name} (${layout.format})`;
        dropdown.appendChild(option);
    });
}

// Event-Listener f√ºr den T-Button
document.getElementById("textModeBtn").addEventListener("click", function() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    addText(centerX, centerY); // Erstellt sofort ein Textfeld in der Mitte des Canvas
});

// ‚úÖ Funktion zum Laden der Daten aus der API per Deeplink
async function loadLayoutFromAPI(layoutId) {
    try {
        const response = await fetch(`https://backendlayoutdesigner-production.up.railway.app/layouts/${layoutId}`);
        if (!response.ok) throw new Error("Fehler beim Laden des Layouts");

        const layoutData = await response.json();
        console.log("üì• Geladenes Layout:", layoutData);

        sessionStorage.setItem("api_layout", JSON.stringify(layoutData));

        // üîÑ API-Variablen √ºbernehmen
        apiVariables.name1 = layoutData.name1 || "NAME 1";
        apiVariables.name2 = layoutData.name2 || "NAME 2";
        apiVariables.weddingDate = layoutData.eventDate || "DD. MMMM YYYY";

        // üü¢ Inputfelder ebenfalls aktualisieren
            updateInputFields();

        console.log("üîπ Aktualisierte API-Werte:", apiVariables);

        if (layoutData.layoutData) {
            console.log("üü¢ Lade gespeichertes Layout auf das Canvas...");
            canvas.loadFromJSON(layoutData.layoutData, () => {
                updateCanvasText();
                canvas.renderAll();
            });
        } else {
            console.log("üëã Kein gespeichertes Layout vorhanden. Zeige Begr√º√üung.");
            loadWelcomeCanvas();
}


        return layoutData;
    } catch (error) {
        console.error("‚ùå Fehler beim Laden des Layouts:", error);
        lockEditor("Fehler: Layout konnte nicht geladen werden.");
        return null;
    }
}

function replacePlaceholders(text) {
    let result = text
        .replace(/name1/g, apiVariables.name1)
        .replace(/name2/g, apiVariables.name2)
        .replace(/weddingDate/g, apiVariables.weddingDate);

    if (apiVariables.name3) {
        result = result.replace(/name3/g, apiVariables.name3);
    }

    return result;
}

function replaceTextPlaceholders() {
    console.log("üîÑ Ersetze Platzhalter ohne Neu-Positionierung...");

    canvas.getObjects().forEach(obj => {
        if (obj.isType("i-text")) {
            let newText = obj.text
                .replace(/name1/g, apiVariables.name1)
                .replace(/name2/g, apiVariables.name2)
                .replace(/weddingDate/g, apiVariables.weddingDate);

            if (apiVariables.name3) {
                newText = newText.replace(/name3/g, apiVariables.name3);
            }

            obj.set("text", newText);
        }
    });

    canvas.renderAll();
    console.log("‚úÖ Platzhalter aktualisiert (keine Neupositionierung).");
}

function changeLayout(layoutId, skipTextRender = false, callback = null) {
    document.getElementById("layoutNotice").textContent = "Aktives Layout:";
    document.getElementById("layoutSelector").classList.remove("intro-style");

    console.log(`üîÑ Wechsle zu Layout ${layoutId}`);
    isProgrammaticLayoutChange = true;

    const savedLayout = sessionStorage.getItem(`custom_layout_${layoutId}`);
    if (savedLayout) {
        const parsed = JSON.parse(savedLayout);
        const layoutData = parsed.data || parsed;
        const format = parsed.format || "15x10";

        setCanvasSizeByFormat(format);
        canvas.clear();

        canvas.loadFromJSON(layoutData, () => {
            canvas.renderAll();
            replaceTextPlaceholders();
            isProgrammaticLayoutChange = false;
            saveTemporaryLayout();

            if (typeof callback === "function") {
                callback(layoutData);
            }
        });

        return;
    }

    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    canvas.clear();
    setCanvasSizeByFormat(layout.format);

    fabric.Image.fromURL(layout.background, function(img) {
        img.set({
            left: 0,
            top: 0,
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height,
            originX: "left",
            originY: "top"
        });

    canvas.setBackgroundImage(img, () => {
    canvas.renderAll();

    updateCanvasText(); // üß† Immer ausf√ºhren, damit auch Swipe die Texte rendert

    if (typeof callback === "function") {
        callback(layout);
    }

    isProgrammaticLayoutChange = false;
});

    }, { crossOrigin: "anonymous" });
}


function updateCanvasText() {
    console.log("üîÑ Update Canvas Text gestartet...");

    const layoutId = document.getElementById("layoutSelector").value;
    if (!layoutId) {
        console.warn("‚ö†Ô∏è Kein Layout ausgew√§hlt f√ºr updateCanvasText()");
        return;
    }

    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    // 1Ô∏è‚É£ Entferne bestehende Textobjekte (werden neu aufgebaut)
    canvas.getObjects().forEach(obj => {
        if (obj.isType("i-text")) {
            canvas.remove(obj);
        }
    });

    // 2Ô∏è‚É£ Gruppierte Texte neu hinzuf√ºgen und korrekt zentrieren
    console.log("üéØ Starte Neuplatzierung der Texte gem√§√ü Layout-Vorgabe...");
    addTextGroups(layout);

    canvas.renderAll();
    console.log("‚úÖ Canvas wurde neu gezeichnet.");

    // 3Ô∏è‚É£ √Ñnderungen speichern ‚Äì wichtig, damit "Bearbeitet"-Status bleibt
    if (!isProgrammaticLayoutChange) {
        console.log("üíæ √Ñnderungen durch updateCanvasText() speichern...");
        saveTemporaryLayout();
    }
}

function addTextGroups(layout) {
    layout.textGroups.forEach(group => {
        let textObjects = [];
        const originY = group.originY || "top";

        // Texte erzeugen
        group.texts.forEach((t) => {
            const textWithVars = replacePlaceholders(t.text || "");

            const textObj = new fabric.IText(textWithVars, {
                fontSize: t.size * canvasScaleY, // vertikale Skalierung
                fontFamily: t.fontFamily || "Arial",
                fontWeight: t.fontWeight || "normal",
                fontStyle: t.fontStyle || "normal",
                charSpacing: t.charSpacing || 0,
                fill: t.fill || "#000000",
                originX: "left",
                originY: originY,
                selectable: canvasScaleX === 1 && canvasScaleY === 1,
                editable: canvasScaleX === 1 && canvasScaleY === 1
            });

            canvas.add(textObj);
            if (DEBUG_MODE) drawDebugBox(textObj); // üü• Debug-Rahmen anzeigen
            textObjects.push(textObj);

            // üìã Konsole zum Vergleich
            console.log(`üß™ "${textWithVars}" | fontSize: ${textObj.fontSize} | width: ${textObj.width.toFixed(1)} | left: ${textObj.left?.toFixed(1)} | scaleX: ${canvasScaleX.toFixed(2)} | scaleY: ${canvasScaleY.toFixed(2)}`);
        });

        canvas.renderAll();

        const spacing = group.spacing * canvasScaleX;
        let totalWidth = textObjects.reduce((sum, obj, index) => {
            return sum + obj.width + (index < textObjects.length - 1 ? spacing : 0);
        }, 0);

        const maxWidth = group.maxWidth * canvasScaleX;
        if (totalWidth > maxWidth) {
            const scaleFactor = maxWidth / totalWidth;
            textObjects.forEach(obj => {
                obj.set("fontSize", obj.fontSize * scaleFactor);
            });
            canvas.renderAll();

            totalWidth = textObjects.reduce((sum, obj, index) => {
                return sum + obj.width + (index < textObjects.length - 1 ? spacing : 0);
            }, 0);
        }

        let startX = group.groupX * canvasScaleX - (totalWidth / 2);
        const top = group.groupY * canvasScaleY;

        textObjects.forEach((obj, index) => {
            obj.set({ left: startX, top: top });
            obj.setCoords();
            startX += obj.width + (index < textObjects.length - 1 ? spacing : 0);
        });

        canvas.renderAll();
        if (DEBUG_MODE) drawGroupCenter(group.groupX * canvasScaleX, group.groupY * canvasScaleY); // üìç Zielposition zeigen

    });
}

function addText(x, y) {
    const text = new fabric.IText("Hier Text eingeben", {
        left: x,
        top: y,
        fontFamily: "Arial",
        fontSize: 20,
        fill: "#000000",
        fontWeight: "normal",
        fontStyle: "normal",
        textAlign: "left",
        selectable: true,
        editable: true
    });

    canvas.add(text);
    canvas.setActiveObject(text);
    text.enterEditing();

    setTimeout(() => {
        if (text.hiddenTextarea) {
            text.hiddenTextarea.focus();
        }
    }, 100); 

    showToolbar();
}

function updateText(property, value) {
          const activeObjects = canvas.getActiveObjects();
          if (activeObjects.length > 0) {
             activeObjects.forEach(obj => {
            if (obj.isType("i-text")) {
                obj.set(property, value);
            }
        });
        canvas.renderAll();
        updateToolbar(); // Toolbar-Werte nach √Ñnderung aktualisieren
        saveTemporaryLayout(); // üîÑ Layout speichern & Dropdown updaten
    }
}
        
function toggleBold() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.isType("i-text")) {
                activeObject.set("fontWeight", activeObject.fontWeight === "bold" ? "normal" : "bold");
                canvas.renderAll();
                saveTemporaryLayout(); // üîÑ Layout speichern & Dropdown updaten
            }
}

function toggleItalic() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.isType("i-text")) {
                activeObject.set("fontStyle", activeObject.fontStyle === "italic" ? "normal" : "italic");
                canvas.renderAll();
                saveTemporaryLayout(); // üîÑ Layout speichern & Dropdown updaten
            }
}

function setAlign(align) {
            const activeObjects = canvas.getActiveObjects();
             if (activeObjects.length > 0) {
                  activeObjects.forEach(obj => {
                  if (obj.isType("i-text")) {
                obj.set({ originX: align });
                saveTemporaryLayout(); // üîÑ Layout speichern & Dropdown updaten
            }
        });
        
        canvas.renderAll();
        updateToolbar(); // üîπ Toolbar nach √Ñnderung aktualisieren
    }
}

function deleteText() {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 0) {
        activeObjects.forEach(obj => {
            if (obj.isType("i-text")) {
                canvas.remove(obj);
            }
        });
        canvas.discardActiveObject();
        canvas.renderAll();
        document.getElementById("toolbar").style.display = "none";
    }
}

function updateToolbar() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || !activeObject.isType("i-text")) {
        document.getElementById("toolbar").style.display = "none";
        return;
    }

    // üîπ Setze die aktuellen Werte aus dem ausgew√§hlten Textfeld
    document.getElementById("fontFamily").value = activeObject.fontFamily || "Arial";
    document.getElementById("fontSize").value = activeObject.fontSize || 30;
    document.getElementById("textColor").value = activeObject.fill || "#000000";

    // üîπ Aktualisiere den Status von Bold & Italic Buttons
    document.querySelector("button[onclick='toggleBold()']").classList.toggle("active", activeObject.fontWeight === "bold");
    document.querySelector("button[onclick='toggleItalic()']").classList.toggle("active", activeObject.fontStyle === "italic");

    // üîπ Setze die richtige Textausrichtung als "active"
    document.querySelectorAll("#toolbar button").forEach(btn => btn.classList.remove("active"));
    if (activeObject.originX) {
        document.querySelector(`button[onclick="setAlign('${activeObject.originX}')"]`)?.classList.add("active");
    }

    // üîπ Toolbar einblenden
    document.getElementById("toolbar").style.display = "flex";
}

function updateToolbar() {
    const activeObjects = canvas.getActiveObjects();
    document.getElementById("toolbar").style.display = activeObjects.length > 0 ? "flex" : "none";
}

function showToolbar() {
     document.getElementById("toolbar").style.display = "flex";
}

    // Falls au√üerhalb eines Textfelds geklickt wird, deaktivieren
    canvas.on("mouse:down", function(event) {
    if (!event.target) {
        if (textModeActive) {
            addText(event.pointer.x, event.pointer.y);
            textModeActive = false; // Nach dem Hinzuf√ºgen deaktivieren
            document.getElementById("textModeBtn").classList.remove("active");
        } else {
            canvas.discardActiveObject();
            canvas.renderAll();
            document.getElementById("toolbar").style.display = "none"; // Toolbar ausblenden
        }
    }
    });

    canvas.on("object:moving", function(event) {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 1) {
        activeObjects.forEach(obj => {
            obj.setCoords(); // Position aktualisieren
        });
    }
    });

    canvas.on("object:moving", function(event) {
            let obj = event.target;
            if (obj && obj.isType("i-text")) {
            console.log(`Text: "${obj.text}" | X: ${Math.round(obj.left)}, Y: ${Math.round(obj.top)}`);
            }
    });

    canvas.on("object:modified", function() {
    updateToolbar();
    });

    canvas.on("mouse:dblclick", function(event) {
    if (event.target && event.target.isType("i-text")) {
        event.target.enterEditing();
        setTimeout(() => {
            event.target.hiddenTextarea?.focus();
        }, 50);
    }
    });

    canvas.on("mouse:down", function(event) {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.isEditing && !event.target) {
        activeObject.exitEditing();
        canvas.discardActiveObject();
        canvas.renderAll();
        document.getElementById("toolbar").style.display = "none";
    }
    });

    canvas.on("selection:created", updateToolbar);
    canvas.on("selection:updated", updateToolbar);
    canvas.on("object:modified", updateToolbar);

    // Jedes Mal, wenn das Canvas ver√§ndert wird, speichere die √Ñnderung tempor√§r
    canvas.on("object:modified", saveTemporaryLayout);
    canvas.on("object:added", saveTemporaryLayout);

    async function saveLayoutToAPI(isFinal = false) {
    const layoutId = document.getElementById("layoutSelector").value;
    const canvasData = JSON.stringify(canvas.toJSON());

    const payload = {
        layoutId: layoutId,
        layoutData: canvasData,
        isFinal: isFinal
    };

    try {
        const response = await fetch(`https://backendlayoutdesigner-production.up.railway.app/layouts/${layoutId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Fehler beim Speichern");

        console.log(`‚úÖ Layout ${layoutId} erfolgreich gespeichert`);
        alert("Layout gespeichert!");
    } catch (error) {
        console.error("‚ùå Fehler beim Speichern:", error);
    }
}      

function updateDropdownStyles() {
    const dropdown = document.getElementById("layoutSelector");
    const options = dropdown.options;

    for (let i = 0; i < options.length; i++) {
        const layoutId = options[i].value;
        const storedLayout = sessionStorage.getItem(`custom_layout_${layoutId}`);

        if (storedLayout) {
            // Pr√ºfe, ob das gespeicherte Layout vom Standard-Layout abweicht
            const originalLayout = layouts.find(l => l.id == layoutId);
            if (originalLayout && JSON.stringify(originalLayout) !== storedLayout) {
                if (!options[i].textContent.includes("[Bearbeitet]")) {
                    options[i].textContent += " [Bearbeitet]";
                }
            }
        } else {
            options[i].textContent = options[i].textContent.replace("‚≠ê Dein Style ", "");
        }
    }
}

function exportCanvasAsPNG() {
    // Speichere die aktuelle Canvas-Gr√∂√üe
    const originalWidth = canvas.width;
    const originalHeight = canvas.height;
    const currentLayout = layouts.find(l => l.id == document.getElementById("layoutSelector").value);

    if (!currentLayout) return;

    let exportWidth, exportHeight;
    if (currentLayout.format === "15x10") {
        exportWidth = 1844;
        exportHeight = 1240;
    } else if (currentLayout.format === "10x15") {
        exportWidth = 1240;
        exportHeight = 1844;
    } else if (currentLayout.format === "15x5") {
        exportWidth = 1844;
        exportHeight = 620;
    } else if (currentLayout.format === "5x15") {
        exportWidth = 620;
        exportHeight = 1844;
    }

    const scaleFactorX = exportWidth / originalWidth;
    const scaleFactorY = exportHeight / originalHeight;

    // 1Ô∏è‚É£ Canvas auf Exportgr√∂√üe setzen
    canvas.setDimensions({ width: exportWidth, height: exportHeight });

    // 2Ô∏è‚É£ Hintergrundbild in Originalgr√∂√üe laden
    fabric.Image.fromURL(currentLayout.background, function(img) {
        img.set({
            left: 0,
            top: 0,
            scaleX: exportWidth / img.width,
            scaleY: exportHeight / img.height,
            originX: "left",
            originY: "top"
        });

        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

        // 3Ô∏è‚É£ Alle Objekte auf Exportgr√∂√üe skalieren
        canvas.getObjects().forEach(obj => {
            obj.set({
                left: obj.left * scaleFactorX,
                top: obj.top * scaleFactorY,
                scaleX: obj.scaleX * scaleFactorX,
                scaleY: obj.scaleY * scaleFactorY
            });
            obj.setCoords();
        });

        canvas.renderAll();

        // 4Ô∏è‚É£ PNG exportieren
        setTimeout(() => {
            const dataURL = canvas.toDataURL({ format: "png", quality: 1 });

            const link = document.createElement("a");
            link.href = dataURL;
            link.download = `layout.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // 5Ô∏è‚É£ Canvas wieder auf Vorschaugr√∂√üe zur√ºcksetzen
            canvas.setDimensions({ width: originalWidth, height: originalHeight });

            // 6Ô∏è‚É£ Hintergrundbild f√ºr Vorschau zur√ºckladen
            fabric.Image.fromURL(currentLayout.background, function(img) {
                img.set({
                    left: 0,
                    top: 0,
                    scaleX: originalWidth / img.width,
                    scaleY: originalHeight / img.height,
                    originX: "left",
                    originY: "top"
                });

                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            });

            // 7Ô∏è‚É£ Alle Objekte auf Vorschaugr√∂√üe zur√ºckskalieren
            canvas.getObjects().forEach(obj => {
                obj.set({
                    left: obj.left / scaleFactorX,
                    top: obj.top / scaleFactorY,
                    scaleX: obj.scaleX / scaleFactorX,
                    scaleY: obj.scaleY / scaleFactorY
                });
                obj.setCoords();
            });

            canvas.renderAll();
        }, 200); // Kleine Verz√∂gerung f√ºr Rendering
    }, { crossOrigin: "anonymous" });
}      
       

document.getElementById("exportBtn").addEventListener("click", function() {
    exportCanvasAsPNG();
});

// üîπ Entferne den doppelten Event Listener f√ºr den Export-Button
document.getElementById("exportBtn").removeEventListener("click", exportCanvasAsPNG);

function updateVariables() {
    // 1Ô∏è‚É£ Neue Werte aus den Eingabefeldern √ºbernehmen
    apiVariables.name1 = document.getElementById("varName1").value;
    apiVariables.name2 = document.getElementById("varName2").value;
    apiVariables.weddingDate = document.getElementById("varWeddingDate").value;

    console.log("üîπ Aktualisierte Variablen:", apiVariables);

    // 2Ô∏è‚É£ JSON-Daten mit neuen Werten √ºberschreiben
    layouts.forEach(layout => {
        layout.textGroups.forEach(group => {
            group.texts.forEach(t => {
                t.text = t.text
                    .replace(/name1/g, apiVariables.name1)
                    .replace(/name2/g, apiVariables.name2)
                    .replace(/weddingDate/g, apiVariables.weddingDate);
            });
        });
    });

    // 3Ô∏è‚É£ Text direkt im Canvas aktualisieren, ohne das Layout neu zu laden
    updateCanvasText();
}

function updateInputFields() {
    const name1Input = document.getElementById("varName1");
    const name2Input = document.getElementById("varName2");
    const dateInput = document.getElementById("varWeddingDate");

    name1Input.value = apiVariables.name1 || "";
    name2Input.value = apiVariables.name2 || "";
    dateInput.value = apiVariables.weddingDate || "";

    // ‚ú® CSS-Highlight-Klasse hinzuf√ºgen und automatisch wieder entfernen
    [name1Input, name2Input, dateInput].forEach(input => {
        input.classList.add("updated");
        setTimeout(() => {
            input.classList.remove("updated");
        }, 1000); // Dauer der Animation
    });
}

function lockEditor(message) {
    // Sperrt die Bearbeitung des Canvas
    canvas.selection = false;
    canvas.forEachObject(obj => obj.selectable = false);
    
    // Zeigt eine Nachricht an
    const lockMessage = document.createElement("div");
    lockMessage.id = "lockMessage";
    lockMessage.innerHTML = `<p>${message}</p>`;
    lockMessage.style.position = "absolute";
    lockMessage.style.top = "50%";
    lockMessage.style.left = "50%";
    lockMessage.style.transform = "translate(-50%, -50%)";
    lockMessage.style.background = "rgba(255, 0, 0, 0.8)";
    lockMessage.style.color = "white";
    lockMessage.style.padding = "15px";
    lockMessage.style.borderRadius = "8px";
    lockMessage.style.fontSize = "18px";
    lockMessage.style.zIndex = "1000";
    document.body.appendChild(lockMessage);
}

function checkLayoutID() {
    const urlParams = new URLSearchParams(window.location.search);
    const layoutId = urlParams.get("id");

    if (!layoutId) {
        console.warn("‚ùå Keine g√ºltige Layout-ID gefunden!");
        lockEditor("Fehler: Keine g√ºltige Layout-ID gefunden. Bitte verwenden Sie einen g√ºltigen Link.");
        return null;
    }

    return layoutId;
}

function saveTemporaryLayout() {
    if (isProgrammaticLayoutChange) {
        console.log("üö´ Layout-Wechsel erkannt ‚Äì tempor√§re Speicherung √ºbersprungen.");
        return;
    }

    const layoutId = document.getElementById("layoutSelector").value;
    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    const canvasData = canvas.toJSON();
    const dataToStore = {
        format: layout.format,
        data: canvasData
    };

    const storedRaw = sessionStorage.getItem(`custom_layout_${layoutId}`);
    const storedParsed = storedRaw ? JSON.parse(storedRaw) : null;

    // Nur speichern, wenn sich etwas ver√§ndert hat
    if (!storedParsed || JSON.stringify(storedParsed.data) !== JSON.stringify(canvasData)) {
        sessionStorage.setItem(`custom_layout_${layoutId}`, JSON.stringify(dataToStore));
        console.log(`üíæ Layout ${layoutId} tempor√§r gespeichert (mit Format: ${layout.format})`);
        updateDropdownStyles();
    }
}

function enableMobileSwipeWithAnimation() {
    if (window.innerWidth >= 768) return;

    const wrapper = document.getElementById("canvasSwipeWrapper");
    const container = document.getElementById("canvas-container");

    let startX = 0;

    wrapper.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
    });

    wrapper.addEventListener("touchend", (e) => {
        const endX = e.changedTouches[0].clientX;
        const deltaX = endX - startX;

        if (Math.abs(deltaX) > 50) {
            const direction = deltaX < 0 ? "next" : "prev";
            animateCanvasSlide(direction);
        }
    });
}

function animateCanvasSlide(direction) {
    if (isSwipeInProgress) return;
    isSwipeInProgress = true;

    const container = document.getElementById("canvas-container");
    const offsetX = direction === "next" ? -100 : 100;

    // üí´ Erst animieren (raus)
    container.style.transition = "transform 0.4s ease, opacity 0.4s ease";
    container.style.transform = `translateX(${offsetX}%)`;
    container.style.opacity = "0";

    setTimeout(() => {
        container.style.transition = "none";
        container.style.transform = `translateX(${-offsetX}%)`;

        // üì¶ Layoutwechsel ausf√ºhren
        loadNextLayout(direction);

        // ‚ú® Neue Animation (rein)
        requestAnimationFrame(() => {
            container.style.transition = "transform 0.4s ease, opacity 0.4s ease";
            container.style.transform = "translateX(0)";
            container.style.opacity = "1";

            // üîì Unlock
            setTimeout(() => {
                isSwipeInProgress = false;
            }, 450);
        });
    }, 400);
}



function loadNextLayout(direction) {
    const dropdown = document.getElementById("layoutSelector");
    const allOptions = Array.from(dropdown.options);
    const enabledOptions = allOptions; // Begr√º√üung ist jetzt swipe-bar

    let currentIndex = enabledOptions.findIndex(opt => opt.value === dropdown.value);
    if (currentIndex === -1) currentIndex = 0;

    let newIndex;
    if (direction === "next") {
        newIndex = (currentIndex + 1) % enabledOptions.length;
    } else {
        newIndex = (currentIndex - 1 + enabledOptions.length) % enabledOptions.length;
    }

    const nextOption = enabledOptions[newIndex];
    dropdown.selectedIndex = newIndex;
    dropdown.value = nextOption.value;

    // üí° Begr√º√üung erkannt
    if (nextOption.value === "") {
        console.log("üëã Swipe zur Begr√º√üung erkannt");
        loadWelcomeCanvas();
        document.getElementById("layoutNotice").textContent = "Willkommen ‚Äì bitte w√§hle ein Layout:";
        return;
    }

    // üîÑ Normales Layout laden
    document.getElementById("layoutNotice").textContent = "Aktives Layout:";
    changeLayout(nextOption.value, false, () => {
        updateCanvasText();
        isProgrammaticLayoutChange = false;
    });
}



function drawDebugBox(obj) {
    const rect = new fabric.Rect({
        left: obj.left,
        top: obj.top,
        width: obj.width,
        height: obj.height,
        stroke: 'red',
        strokeWidth: 1,
        fill: 'transparent',
        selectable: false,
        evented: false
    });
    canvas.add(rect);
}

function drawGroupCenter(x, y) {
    const circle = new fabric.Circle({
        left: x - 4,
        top: y - 4,
        radius: 4,
        fill: 'blue',
        stroke: 'white',
        strokeWidth: 1,
        selectable: false,
        evented: false
    });
    canvas.add(circle);
}

// Toggle bei Klick auf Handle (z.‚ÄØB. Desktop)
sheetHandle.addEventListener("click", () => {
  bottomSheet.classList.toggle("expanded");
  document.body.classList.toggle("sheet-open");
});

// Drag (touch) f√ºrs Mobilger√§t
sheetHandle.addEventListener("touchstart", (e) => {
  startY = e.touches[0].clientY;
  isDragging = true;
});

sheetHandle.addEventListener("touchmove", (e) => {
  if (!isDragging) return;
  const deltaY = e.touches[0].clientY - startY;

  if (deltaY < -30) {
    bottomSheet.classList.add("expanded");
    document.body.classList.add("sheet-open");
  } else if (deltaY > 30) {
    bottomSheet.classList.remove("expanded");
    document.body.classList.remove("sheet-open");
  }
});

sheetHandle.addEventListener("touchend", () => {
  isDragging = false;
});

// üßπ Bei Touch auf Canvas: Sheet schlie√üen
document.getElementById("canvas-container").addEventListener("touchstart", () => {
  bottomSheet.classList.remove("expanded");
  document.body.classList.remove("sheet-open");
});


</script>
</body>
</html>
