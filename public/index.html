<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LAYOUT-DESIGNER</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
        
        <!-- Google Fonts einbinden -->
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
                }
            
            #main {
                display: flex;
                flex: 1;
                overflow: hidden;
                }

            #canvasSection {
                flex: 2;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #fafafa;
                border-right: 2px solid #ddd;
                padding: 20px;
                }

            #canvas-container {
                border: 2px solid black;
                background: white;
                }

            #toolPanel {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                background-color: #f4f4f4;
                }

            #toolbar {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                width: 220px;
                padding: 12px;
                background: #f8f8f8;
                border-left: 2px solid #ccc;
                box-shadow: -2px 0 5px rgba(0,0,0,0.05);
                font-family: Raleway, sans-serif;
                font-size: 14px;
                }

            .tool-section {
                margin-bottom: 18px;
                padding-bottom: 10px;
                border-bottom: 1px dashed #ddd;
                }

            .tool-section label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #444;
                }

            .tool-section button,
            .tool-section select,
            .tool-section input[type="number"],
            .tool-section input[type="color"] {
                width: 100%;
                margin: 3px 0;
                padding: 6px;
                box-sizing: border-box;
                }

            .save-actions {
                margin-top: auto;
                padding-top: 12px;
                border-top: 2px solid #999;
                }
    
            button, select, input {
                margin: 4px;
                padding: 6px;
                }

            select.intro-style {
                font-weight: bold;
                color: #444;
                border: 2px solid #ff9800;
                background-color: #fff8e1;
                box-shadow: 0 0 5px rgba(255, 152, 0, 0.6);
                transition: all 0.3s ease;
            }

            #layoutSelector.intro-style {
                border: 2px dashed #999;
                background-color: #f9f9f9;
                color: #666;
            }

            input.updated {
                animation: highlightFade 1s ease;
                background-color: #d4edda; /* leichtes grün */
                border: 1px solid #28a745;
            }

            #apiVariableEditor {
                margin-top: 20px;
            }

            @keyframes highlightFade {
            from {
                background-color: #d4edda;
            }
            to {
                background-color: white;
            }

            @media (max-width: 768px) {
            #main {
                flex-direction: column;
            }

            body {
                background: lightyellow;
            }

            #canvasSection, #toolPanel {
                flex: unset;
                width: 100%;
                border: none;
                padding: 10px;
            }

            #canvas-container {
                width: 100%;
                max-width: 100%;
            }

            canvas {
                max-width: 100%;
                height: auto;
            }

            #toolbar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
            }

            .tool-section {
                flex: 1 1 45%;
                margin-bottom: 10px;
                padding: 5px;
                border-bottom: none;
                border-right: 1px dashed #ccc;
            }

            .save-actions {
                flex-basis: 100%;
                border-top: 1px solid #999;
                margin-top: 10px;
            }

            #layoutSelector {
                width: 100%;
            }
        }

            @media (max-width: 2000px) {
            body {
                background: yellow !important;
            }
}


}

        </style>
    </head>
    
<body>
    <header style="padding: 10px; text-align: center; background-color: #222; color: white;">
        <h2>LAYOUT-DESIGNER</h2>
      </header>

      <div id="main">
        <!-- Canvas Section -->
        <div id="canvasSection">
          <div id="canvas-container">
            <canvas id="canvas" width="800" height="400"></canvas>
          </div>
        </div>
    
        <!-- Tool Panel -->
        <div id="toolPanel">
          <div>
            <span id="layoutNotice"><strong>Willkommen! Wähle ein Layout, um zu starten:</strong></span><br><br>
            <select id="layoutSelector" onchange="changeLayout(this.value)"></select>
          </div>
    
          <div id="apiVariableEditor">
            <h3>Variablen bearbeiten</h3>
            <label>Name 1: <input type="text" id="varName1" value="SOPHIE"></label><br>
            <label>Name 2: <input type="text" id="varName2" value="MAX"></label><br>
            <label>Datum: <input type="text" id="varWeddingDate" value="12. März 2025"></label><br>
            <button onclick="updateVariables()">Variablen speichern</button>
          </div>
    
          <div id="toolbar">
            <div class="tool-section">
              <label for="fontFamily">Schriftart:</label>
              <select id="fontFamily" onchange="updateText('fontFamily', this.value)">
                <option value="Raleway">Raleway</option>
                <option value="Baskerville">Baskerville</option>
                <option value="Arial">Arial</option>
                <option value="Verdana">Verdana</option>
                <option value="Courier New">Courier</option>
                <option value="Georgia">Georgia</option>
              </select>
            </div>
          
            <div class="tool-section">
              <label for="fontSize">Größe:</label>
              <input type="number" id="fontSize" value="30" min="10" max="100" onchange="updateText('fontSize', this.value)">
            </div>
          
            <div class="tool-section">
              <label for="textColor">Farbe:</label>
              <input type="color" id="textColor" onchange="updateText('fill', this.value)">
            </div>
          
            <div class="tool-section">
              <label>Stil:</label>
              <button onclick="toggleBold()">B</button>
              <button onclick="toggleItalic()">I</button>
            </div>
          
            <div class="tool-section">
              <label>Ausrichtung:</label>
              <button onclick="setAlign('left')">⬅</button>
              <button onclick="setAlign('center')">🔳</button>
              <button onclick="setAlign('right')">➡</button>
            </div>
          
            <div class="tool-section">
              <button id="textModeBtn">➕ Textfeld</button>
              <button onclick="deleteText()">🗑 Löschen</button>
            </div>
          
            <div class="tool-section save-actions">
              <button onclick="saveLayoutToAPI(false)">💾 Speichern</button>
              <button onclick="saveLayoutToAPI(true)">🚀 Freigeben</button>
              <button id="exportBtn">📤 PNG Export</button>
            </div>
          </div>
          
        </div>
      </div>

    <script>
        const layouts = [
    { id: 1, name: "Style 1 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style1.png", textGroups: [
            { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 84,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 450, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 103,  // Vertikale Position
                spacing: 15,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "• weddingDate •", size: 18, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 156,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 2, name: "Style 2 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style2.png", textGroups: [
            { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 282,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 18, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 18, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 18, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "•  weddingDate", size: 18, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 301,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 3, name: "Style 3 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style3.png", textGroups: [
            { groupId: "names1", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 127,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 27, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            { groupId: "and", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 133,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                texts: [
                    { text: "und", size: 18, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 200, fill: "#000000"}
                ]
            },
            { groupId: "names2", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 166,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 250, // Maximale Breite der Gruppe
                originY: "top",
                texts: [
                    { text: "name2", size: 27, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            { groupId: "date", 
                groupX: 155,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 215,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 155,  // Zentrum der Gruppe
                groupY: 370,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },
    
    { id: 4, name: "Style 4 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style4.png", textGroups: [
    { groupId: "names", 
                groupX: 166,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 72,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 230, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 20, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 20, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 20, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 166,  // Zentrum der Gruppe
                groupY: 96,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 166,  // Zentrum der Gruppe
                groupY: 161,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 5, name: "Style 5 - 10x15 - 6 Fotos", format: "10x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style5.png", textGroups: [
    { groupId: "names", 
                groupX: 200,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 463,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 350, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 28, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 200,  // Zentrum der Gruppe
                groupY: 490,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 14, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 200,  // Zentrum der Gruppe
                groupY: 560,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 6, name: "Style 6 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style6.png", textGroups: [
    { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 88,   // Vertikale Position der Gruppe
                spacing: 15,  // Abstand zwischen den Texten
                maxWidth: 500, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 107,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 14, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 383,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 7, name: "Style 7 - 15x10 - 3 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style7.png", textGroups: [
    { groupId: "names", 
                groupX: 120,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 186,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 200, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 16, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 120,  // Zentrum der Gruppe
                groupY: 146,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "Erinnerungen für die Ewigkeit", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"} ,
                    { text: "|", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"} ,
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 120,  // Zentrum der Gruppe
                groupY: 206,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 8, name: "Style 8 - 15x10 - 2 Fotos", format: "15x10", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style8.png", textGroups: [
    { groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 59,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 285, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "name1", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 30, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 30, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 367,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS®", size: 10, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 9, name: "Style 9 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style9.png", textGroups: [
            {   groupId: "names1", 
                groupX: 68,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 77,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "name1", size: 21, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 68,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 124,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 100, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "&", size: 21, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 21, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 68,  // Zentrum der Gruppe
                groupY: 46,  // Vertikale Position
                spacing: 5,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 68,  // Zentrum der Gruppe
                groupY: 145,  // Vertikale Position
                spacing: 15,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 7, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 10, name: "Style 10 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style10.png", textGroups: [
            {   groupId: "names1", 
                groupX: 507,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 50,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 110, // Maximale Breite der Gruppe
                texts: [
                    { text: "name1", size: 20, fontFamily: "Raleway", charSpacing: 200, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 507,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 73,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 110, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 20, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 20, fontFamily: "Raleway", charSpacing: 200, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 507,  // Zentrum der Gruppe
                groupY: 103,  // Vertikale Position
                spacing: 5,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 8, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 507,  // Zentrum der Gruppe
                groupY: 159,  // Vertikale Position
                spacing: 15,
                maxWidth: 100, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 11, name: "Style 11 - 15x5 - 2 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style11.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 160,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 285, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "• name1", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2 •", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 175,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS®", size: 10, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 12, name: "Style 12 - 15x5 - 3 Fotos", format: "15x5", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style12.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 300,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 18,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 400, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "• name1", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 14, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2 •", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date_ad",
                groupX: 300,  // Zentrum der Gruppe
                groupY: 175,  // Vertikale Position
                spacing: 5,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "Ab jetzt - für immer |", size: 9, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"} ,
                    { text: "weddingDate", size: 9, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"},
                    { text: "| EINFACH KNIPS®", size: 9, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 13, name: "Style 13 - 5x15 - 4 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style13.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 533,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "&", size: 15, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 15, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 547,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 12, fontFamily: "Raleway", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 577,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 14, name: "Style 14 - 5x15 - 3 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style14.png", textGroups: [
    {   groupId: "names1", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 63,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 61,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 24, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 107,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 542,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 15, name: "Style 15 - 5x15 - 3 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style15.png", textGroups: [
    {   groupId: "names1", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 205,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                ]
            },
            {   groupId: "names2", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 201,   // Vertikale Position der Gruppe
                spacing: 5,  // Abstand zwischen den Texten
                maxWidth: 160, // Maximale Breite der Gruppe
                texts: [
                    { text: "&", size: 24, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 100, fill: "#000000"},
                    { text: "name2", size: 24, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 237,  // Vertikale Position
                spacing: 5,
                maxWidth: 200, // Maximale Breite der Gruppe
                texts: [
                    { text: "• weddingDate •", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 572,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },

    { id: 16, name: "Style 16 - 5x15 - 4 Fotos", format: "5x15", background: "https://app.layoutdesigner.einfach-knips.de/public_html/assets/style16.png", textGroups: [
            { 
                groupId: "names", 
                groupX: 100,  // Mittelpunkt der Gruppe auf X-Achse
                groupY: 30,   // Vertikale Position der Gruppe
                spacing: 10,  // Abstand zwischen den Texten
                maxWidth: 170, // Maximale Breite der Gruppe
                originY: "bottom",
                texts: [
                    { text: "name1", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "+", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"},
                    { text: "name2", size: 14, fontFamily: "Raleway", charSpacing: 300, fill: "#000000"}
                ]
            },
            {
                groupId: "date",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 558,  // Vertikale Position
                spacing: 5,
                maxWidth: 80, // Maximale Breite der Gruppe
                originY: "center",
                texts: [
                    { text: "weddingDate", size: 10, fontFamily: "Baskerville", fontWeight: "italic", charSpacing: 80, fill: "#000000"}
                ]
            },
            {
                groupId: "ad",
                groupX: 100,  // Zentrum der Gruppe
                groupY: 574,  // Vertikale Position
                spacing: 15,
                maxWidth: 500, // Maximale Breite der Gruppe
                texts: [
                    { text: "EINFACH KNIPS®", size: 8, fontFamily: "Raleway", charSpacing: 100, fill: "#000000"}
                ]
            }
        ]
    },
 ]

const canvas = new fabric.Canvas("canvas");

canvas.selection = true; // Mehrfachauswahl durch Auswahlbox aktivieren
        
let textModeActive = false; // Standard: Kein neues Textfeld erstellen
let isProgrammaticLayoutChange = false; // Temporäre Sperre beim Initialaufbau des Layouts

 // 🔹 Globale API-Variablen
const apiVariables = {
    name1: "ERIKA",
    name2: "MAX",
    weddingDate: "01. Januar 1978",
};

function setCanvasSizeByFormat(format) {
    if (format === "15x10") {
        canvas.setDimensions({ width: 600, height: 400 });
    } else if (format === "10x15") {
        canvas.setDimensions({ width: 400, height: 600 });
    } else if (format === "15x5") {
        canvas.setDimensions({ width: 600, height: 200 });
    } else if (format === "5x15") {
        canvas.setDimensions({ width: 200, height: 600 });
    } else {
        canvas.setDimensions({ width: 600, height: 400 }); // Fallback
    }
}

function loadWelcomeCanvas() {
    canvas.clear();
    setCanvasSizeByFormat("15x10");

    const welcomeText = new fabric.IText(
        "👋 Willkommen beim Layout-Designer!\n\n➤ Wähle oben ein Layout aus\n➤ Bearbeite Namen und Datum\n➤ Füge eigene Texte hinzu\n\n🎨 Nutze die Werkzeugleiste unter dem Canvas!",
        {
            left: 80,
            top: 80,
            fontSize: 20,
            fontFamily: "Raleway",
            fill: "#333",
            width: 450,
            textAlign: "left",
            editable: false,
            selectable: false
        }
    );

    canvas.add(welcomeText);
    canvas.renderAll();

    const dropdown = document.getElementById("layoutSelector");
    dropdown.value = "";
    dropdown.classList.add("intro-style");

    // ⬆️ Optional optische Hervorhebung
    dropdown.style.border = "2px dashed #888";
    dropdown.style.backgroundColor = "#f8f8f8";

    // Hinweis über dem Dropdown
    document.getElementById("layoutNotice").textContent = "Willkommen – bitte wähle ein Layout:";
}

 
document.addEventListener("DOMContentLoaded", () => {
    populateDropdown();

    const layoutId = checkLayoutID();
    if (layoutId) {
        console.log("🔗 Lade Layout aus API für ID:", layoutId);
        loadLayoutFromAPI(layoutId);
    }

    // ✅ API-Werte direkt setzen, falls kein API-Call stattfindet
    setTimeout(() => {
        updateCanvasText();
    }, 300);
    
    // ✅ NEU: Aktualisiere Dropdown-Stile beim Start
        updateDropdownStyles();
});

document.addEventListener("keydown", function(event) {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) return;

    // Falls das Textfeld gerade bearbeitet wird
    if (activeObject.isEditing) {
        if (event.key === "Enter") {
            activeObject.exitEditing();
            canvas.discardActiveObject();
            canvas.renderAll();
            document.getElementById("toolbar").style.display = "none";
            event.preventDefault();
        }
        return; // 🔹 Falls bearbeitet wird, keine weiteren Aktionen ausführen
    }

    // Falls kein Bearbeitungsmodus aktiv ist
    if (event.key === "Delete" || event.key === "Backspace") {
        deleteText();
        event.preventDefault();
    }

    // Pfeiltasten: Nur wenn nicht im Edit-Modus
    if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(event.key)) {
        let step = event.shiftKey ? 10 : 1;
        
        if (event.key === "ArrowLeft") activeObject.set("left", activeObject.left - step);
        if (event.key === "ArrowRight") activeObject.set("left", activeObject.left + step);
        if (event.key === "ArrowUp") activeObject.set("top", activeObject.top - step);
        if (event.key === "ArrowDown") activeObject.set("top", activeObject.top + step);

        activeObject.setCoords();
        canvas.renderAll();
        
        // 🔹 NEU: Zeigt die aktuelle Position in der Konsole an
        console.log(`Text: "${activeObject.text}" | X: ${Math.round(activeObject.left)}, Y: ${Math.round(activeObject.top)}`);

        event.preventDefault();
    }
});

function populateDropdown() {
    const dropdown = document.getElementById("layoutSelector");

    // 🟡 Willkommensoption ganz oben
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "🖐 Noch kein Layout ausgewählt";
    defaultOption.disabled = true;
    defaultOption.selected = true;
    dropdown.appendChild(defaultOption);

    // 🔄 Alle echten Layouts hinzufügen
    layouts.forEach(layout => {
        const option = document.createElement("option");
        option.value = layout.id;
        option.textContent = `${layout.name} (${layout.format})`;
        dropdown.appendChild(option);
    });
}

// Event-Listener für den T-Button
document.getElementById("textModeBtn").addEventListener("click", function() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    addText(centerX, centerY); // Erstellt sofort ein Textfeld in der Mitte des Canvas
});

// ✅ Funktion zum Laden der Daten aus der API per Deeplink
async function loadLayoutFromAPI(layoutId) {
    try {
        const response = await fetch(`https://backendlayoutdesigner-production.up.railway.app/layouts/${layoutId}`);
        if (!response.ok) throw new Error("Fehler beim Laden des Layouts");

        const layoutData = await response.json();
        console.log("📥 Geladenes Layout:", layoutData);

        sessionStorage.setItem("api_layout", JSON.stringify(layoutData));

        // 🔄 API-Variablen übernehmen
        apiVariables.name1 = layoutData.name1 || "NAME 1";
        apiVariables.name2 = layoutData.name2 || "NAME 2";
        apiVariables.weddingDate = layoutData.eventDate || "DD. MMMM YYYY";

        // 🟢 Inputfelder ebenfalls aktualisieren
            updateInputFields();

        console.log("🔹 Aktualisierte API-Werte:", apiVariables);

        if (layoutData.layoutData) {
            console.log("🟢 Lade gespeichertes Layout auf das Canvas...");
            canvas.loadFromJSON(layoutData.layoutData, () => {
                updateCanvasText();
                canvas.renderAll();
            });
        } else {
            console.log("👋 Kein gespeichertes Layout vorhanden. Zeige Begrüßung.");
            loadWelcomeCanvas();
}


        return layoutData;
    } catch (error) {
        console.error("❌ Fehler beim Laden des Layouts:", error);
        lockEditor("Fehler: Layout konnte nicht geladen werden.");
        return null;
    }
}

function replacePlaceholders(text) {
    let result = text
        .replace(/name1/g, apiVariables.name1)
        .replace(/name2/g, apiVariables.name2)
        .replace(/weddingDate/g, apiVariables.weddingDate);

    if (apiVariables.name3) {
        result = result.replace(/name3/g, apiVariables.name3);
    }

    return result;
}

function replaceTextPlaceholders() {
    console.log("🔄 Ersetze Platzhalter ohne Neu-Positionierung...");

    canvas.getObjects().forEach(obj => {
        if (obj.isType("i-text")) {
            let newText = obj.text
                .replace(/name1/g, apiVariables.name1)
                .replace(/name2/g, apiVariables.name2)
                .replace(/weddingDate/g, apiVariables.weddingDate);

            if (apiVariables.name3) {
                newText = newText.replace(/name3/g, apiVariables.name3);
            }

            obj.set("text", newText);
        }
    });

    canvas.renderAll();
    console.log("✅ Platzhalter aktualisiert (keine Neupositionierung).");
}

function changeLayout(layoutId) {
    document.getElementById("layoutNotice").textContent = "Aktives Layout:";
    document.getElementById("layoutSelector").classList.remove("intro-style");

    console.log(`🔄 Wechsle zu Layout ${layoutId}`);
    isProgrammaticLayoutChange = true;

    const savedLayout = sessionStorage.getItem(`custom_layout_${layoutId}`);
    if (savedLayout) {
        console.log(`🟡 Lade benutzerdefinierten Style für Layout ${layoutId}`);
        
        const parsed = JSON.parse(savedLayout);
        const layoutData = parsed.data || parsed; // Fallback falls altes Format
        const format = parsed.format || "15x10";  // Default bei alten Speicherungen

        // ⬇️ Neue Hilfsfunktion zum Setzen der Größe (definieren wir unten)
        setCanvasSizeByFormat(format);

        canvas.clear();
        canvas.loadFromJSON(layoutData, () => {
            canvas.renderAll();
            replaceTextPlaceholders(); // ✅ Nur Text aktualisieren
            isProgrammaticLayoutChange = false;

            // ⬇️ Neu: explizit speichern
            saveTemporaryLayout(); // damit es sicher im SessionStorage landet
        });
        return;
    }

    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    canvas.clear();

    fabric.Image.fromURL(layout.background, function(img) {
        img.set({
            left: 0,
            top: 0,
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height,
            originX: "left",
            originY: "top"
        });

        canvas.setBackgroundImage(img, () => {
            canvas.renderAll();
        });
    }, { crossOrigin: "anonymous" });

    // ⬇️ Hier ersetzen wir die Format-Logik durch dieselbe Hilfsfunktion
    setCanvasSizeByFormat(layout.format);

    addTextGroups(layout);
    updateCanvasText();
    isProgrammaticLayoutChange = false;
}

function updateCanvasText() {
    console.log("🔄 Update Canvas Text gestartet...");

    const layoutId = document.getElementById("layoutSelector").value;
    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    // 1️⃣ Entferne bestehende Textobjekte (werden neu aufgebaut)
    canvas.getObjects().forEach(obj => {
        if (obj.isType("i-text")) {
            canvas.remove(obj);
        }
    });

    // 2️⃣ Gruppierte Texte neu hinzufügen und korrekt zentrieren
    console.log("🎯 Starte Neuplatzierung der Texte gemäß Layout-Vorgabe...");
    addTextGroups(layout);

    canvas.renderAll();
    console.log("✅ Canvas wurde neu gezeichnet.");

    // 3️⃣ Änderungen speichern – wichtig, damit "Bearbeitet"-Status bleibt
    if (!isProgrammaticLayoutChange) {
        console.log("💾 Änderungen durch updateCanvasText() speichern...");
        saveTemporaryLayout();
    }
}


function addTextGroups(layout) {
    layout.textGroups.forEach(group => {
        let textObjects = [];

        // Falls kein originY definiert ist, nutze "top" als Standard
        const originY = group.originY || "top"; 

        // 1️⃣ Erstelle die Texte & ersetze Platzhalter direkt beim Anlegen
        group.texts.forEach((t) => {
            const textWithVars = replacePlaceholders(t.text || "");

            const textObj = new fabric.IText(textWithVars, {
                fontSize: t.size,
                fontFamily: t.fontFamily || "Arial",
                fontWeight: t.fontWeight || "normal",
                fontStyle: t.fontStyle || "normal",
                charSpacing: t.charSpacing || 0,
                fill: t.fill || "#000000",
                originX: "left",
                originY: originY,
                selectable: true,
                editable: true
            });

            canvas.add(textObj);
            textObjects.push(textObj);
        });

        // 🔧 Nach dem Hinzufügen rendern, damit Breiten korrekt berechnet werden
        canvas.renderAll();

        // 2️⃣ Berechne die Gesamtbreite der Gruppe inkl. Spacing
        let totalWidth = textObjects.reduce((sum, obj, index) => {
            return sum + obj.width + (index < textObjects.length - 1 ? group.spacing : 0);
        }, 0);

        // 3️⃣ Falls zu breit, verkleinere proportional
        if (totalWidth > group.maxWidth) {
            let scaleFactor = group.maxWidth / totalWidth;
            textObjects.forEach(obj => {
                obj.set("fontSize", obj.fontSize * scaleFactor);
            });

            canvas.renderAll(); // 🔄 Width nach Update neu berechnen

            totalWidth = textObjects.reduce((sum, obj, index) => {
                return sum + obj.width + (index < textObjects.length - 1 ? group.spacing : 0);
            }, 0);
        }

        // 4️⃣ Starte bei zentriertem X-Offset
        let startX = group.groupX - (totalWidth / 2);

        // 5️⃣ Positioniere alle Texte mit Abstand
        console.log("Größencheck:");
        textObjects.forEach((obj, index) => {
            console.log(`🔹 ${obj.text} → width: ${obj.width}, scaleX: ${obj.scaleX}, getScaledWidth: ${obj.getScaledWidth?.()}`);
            obj.set({ left: startX, top: group.groupY });
            obj.setCoords();
            startX += obj.width + (index < textObjects.length - 1 ? group.spacing : 0);
        });

        canvas.renderAll();
    });
}


function addText(x, y) {
    const text = new fabric.IText("Hier Text eingeben", {
        left: x,
        top: y,
        fontFamily: "Arial",
        fontSize: 20,
        fill: "#000000",
        fontWeight: "normal",
        fontStyle: "normal",
        textAlign: "left",
        selectable: true,
        editable: true
    });

    canvas.add(text);
    canvas.setActiveObject(text);
    text.enterEditing();

    setTimeout(() => {
        if (text.hiddenTextarea) {
            text.hiddenTextarea.focus();
        }
    }, 100); 

    showToolbar();
}

function updateText(property, value) {
          const activeObjects = canvas.getActiveObjects();
          if (activeObjects.length > 0) {
             activeObjects.forEach(obj => {
            if (obj.isType("i-text")) {
                obj.set(property, value);
            }
        });
        canvas.renderAll();
        updateToolbar(); // Toolbar-Werte nach Änderung aktualisieren
        saveTemporaryLayout(); // 🔄 Layout speichern & Dropdown updaten
    }
}
        
function toggleBold() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.isType("i-text")) {
                activeObject.set("fontWeight", activeObject.fontWeight === "bold" ? "normal" : "bold");
                canvas.renderAll();
                saveTemporaryLayout(); // 🔄 Layout speichern & Dropdown updaten
            }
}

function toggleItalic() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.isType("i-text")) {
                activeObject.set("fontStyle", activeObject.fontStyle === "italic" ? "normal" : "italic");
                canvas.renderAll();
                saveTemporaryLayout(); // 🔄 Layout speichern & Dropdown updaten
            }
}

function setAlign(align) {
            const activeObjects = canvas.getActiveObjects();
             if (activeObjects.length > 0) {
                  activeObjects.forEach(obj => {
                  if (obj.isType("i-text")) {
                obj.set({ originX: align });
                saveTemporaryLayout(); // 🔄 Layout speichern & Dropdown updaten
            }
        });
        
        canvas.renderAll();
        updateToolbar(); // 🔹 Toolbar nach Änderung aktualisieren
    }
}

function deleteText() {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 0) {
        activeObjects.forEach(obj => {
            if (obj.isType("i-text")) {
                canvas.remove(obj);
            }
        });
        canvas.discardActiveObject();
        canvas.renderAll();
        document.getElementById("toolbar").style.display = "none";
    }
}

function updateToolbar() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || !activeObject.isType("i-text")) {
        document.getElementById("toolbar").style.display = "none";
        return;
    }

    // 🔹 Setze die aktuellen Werte aus dem ausgewählten Textfeld
    document.getElementById("fontFamily").value = activeObject.fontFamily || "Arial";
    document.getElementById("fontSize").value = activeObject.fontSize || 30;
    document.getElementById("textColor").value = activeObject.fill || "#000000";

    // 🔹 Aktualisiere den Status von Bold & Italic Buttons
    document.querySelector("button[onclick='toggleBold()']").classList.toggle("active", activeObject.fontWeight === "bold");
    document.querySelector("button[onclick='toggleItalic()']").classList.toggle("active", activeObject.fontStyle === "italic");

    // 🔹 Setze die richtige Textausrichtung als "active"
    document.querySelectorAll("#toolbar button").forEach(btn => btn.classList.remove("active"));
    if (activeObject.originX) {
        document.querySelector(`button[onclick="setAlign('${activeObject.originX}')"]`)?.classList.add("active");
    }

    // 🔹 Toolbar einblenden
    document.getElementById("toolbar").style.display = "flex";
}

function updateToolbar() {
    const activeObjects = canvas.getActiveObjects();
    document.getElementById("toolbar").style.display = activeObjects.length > 0 ? "flex" : "none";
}

function showToolbar() {
     document.getElementById("toolbar").style.display = "flex";
}

    // Falls außerhalb eines Textfelds geklickt wird, deaktivieren
    canvas.on("mouse:down", function(event) {
    if (!event.target) {
        if (textModeActive) {
            addText(event.pointer.x, event.pointer.y);
            textModeActive = false; // Nach dem Hinzufügen deaktivieren
            document.getElementById("textModeBtn").classList.remove("active");
        } else {
            canvas.discardActiveObject();
            canvas.renderAll();
            document.getElementById("toolbar").style.display = "none"; // Toolbar ausblenden
        }
    }
    });

    canvas.on("object:moving", function(event) {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 1) {
        activeObjects.forEach(obj => {
            obj.setCoords(); // Position aktualisieren
        });
    }
    });

    canvas.on("object:moving", function(event) {
            let obj = event.target;
            if (obj && obj.isType("i-text")) {
            console.log(`Text: "${obj.text}" | X: ${Math.round(obj.left)}, Y: ${Math.round(obj.top)}`);
            }
    });

    canvas.on("object:modified", function() {
    updateToolbar();
    });

    canvas.on("mouse:dblclick", function(event) {
    if (event.target && event.target.isType("i-text")) {
        event.target.enterEditing();
        setTimeout(() => {
            event.target.hiddenTextarea?.focus();
        }, 50);
    }
    });

    canvas.on("mouse:down", function(event) {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.isEditing && !event.target) {
        activeObject.exitEditing();
        canvas.discardActiveObject();
        canvas.renderAll();
        document.getElementById("toolbar").style.display = "none";
    }
    });

    canvas.on("selection:created", updateToolbar);
    canvas.on("selection:updated", updateToolbar);
    canvas.on("object:modified", updateToolbar);

    // Jedes Mal, wenn das Canvas verändert wird, speichere die Änderung temporär
    canvas.on("object:modified", saveTemporaryLayout);
    canvas.on("object:added", saveTemporaryLayout);

    async function saveLayoutToAPI(isFinal = false) {
    const layoutId = document.getElementById("layoutSelector").value;
    const canvasData = JSON.stringify(canvas.toJSON());

    const payload = {
        layoutId: layoutId,
        layoutData: canvasData,
        isFinal: isFinal
    };

    try {
        const response = await fetch(`https://backendlayoutdesigner-production.up.railway.app/layouts/${layoutId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Fehler beim Speichern");

        console.log(`✅ Layout ${layoutId} erfolgreich gespeichert`);
        alert("Layout gespeichert!");
    } catch (error) {
        console.error("❌ Fehler beim Speichern:", error);
    }
}      

function updateDropdownStyles() {
    const dropdown = document.getElementById("layoutSelector");
    const options = dropdown.options;

    for (let i = 0; i < options.length; i++) {
        const layoutId = options[i].value;
        const storedLayout = sessionStorage.getItem(`custom_layout_${layoutId}`);

        if (storedLayout) {
            // Prüfe, ob das gespeicherte Layout vom Standard-Layout abweicht
            const originalLayout = layouts.find(l => l.id == layoutId);
            if (originalLayout && JSON.stringify(originalLayout) !== storedLayout) {
                if (!options[i].textContent.includes("[Bearbeitet]")) {
                    options[i].textContent += " [Bearbeitet]";
                }
            }
        } else {
            options[i].textContent = options[i].textContent.replace("⭐ Dein Style ", "");
        }
    }
}

function exportCanvasAsPNG() {
    // Speichere die aktuelle Canvas-Größe
    const originalWidth = canvas.width;
    const originalHeight = canvas.height;
    const currentLayout = layouts.find(l => l.id == document.getElementById("layoutSelector").value);

    if (!currentLayout) return;

    let exportWidth, exportHeight;
    if (currentLayout.format === "15x10") {
        exportWidth = 1844;
        exportHeight = 1240;
    } else if (currentLayout.format === "10x15") {
        exportWidth = 1240;
        exportHeight = 1844;
    } else if (currentLayout.format === "15x5") {
        exportWidth = 1844;
        exportHeight = 620;
    } else if (currentLayout.format === "5x15") {
        exportWidth = 620;
        exportHeight = 1844;
    }

    const scaleFactorX = exportWidth / originalWidth;
    const scaleFactorY = exportHeight / originalHeight;

    // 1️⃣ Canvas auf Exportgröße setzen
    canvas.setDimensions({ width: exportWidth, height: exportHeight });

    // 2️⃣ Hintergrundbild in Originalgröße laden
    fabric.Image.fromURL(currentLayout.background, function(img) {
        img.set({
            left: 0,
            top: 0,
            scaleX: exportWidth / img.width,
            scaleY: exportHeight / img.height,
            originX: "left",
            originY: "top"
        });

        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

        // 3️⃣ Alle Objekte auf Exportgröße skalieren
        canvas.getObjects().forEach(obj => {
            obj.set({
                left: obj.left * scaleFactorX,
                top: obj.top * scaleFactorY,
                scaleX: obj.scaleX * scaleFactorX,
                scaleY: obj.scaleY * scaleFactorY
            });
            obj.setCoords();
        });

        canvas.renderAll();

        // 4️⃣ PNG exportieren
        setTimeout(() => {
            const dataURL = canvas.toDataURL({ format: "png", quality: 1 });

            const link = document.createElement("a");
            link.href = dataURL;
            link.download = `layout.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // 5️⃣ Canvas wieder auf Vorschaugröße zurücksetzen
            canvas.setDimensions({ width: originalWidth, height: originalHeight });

            // 6️⃣ Hintergrundbild für Vorschau zurückladen
            fabric.Image.fromURL(currentLayout.background, function(img) {
                img.set({
                    left: 0,
                    top: 0,
                    scaleX: originalWidth / img.width,
                    scaleY: originalHeight / img.height,
                    originX: "left",
                    originY: "top"
                });

                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            });

            // 7️⃣ Alle Objekte auf Vorschaugröße zurückskalieren
            canvas.getObjects().forEach(obj => {
                obj.set({
                    left: obj.left / scaleFactorX,
                    top: obj.top / scaleFactorY,
                    scaleX: obj.scaleX / scaleFactorX,
                    scaleY: obj.scaleY / scaleFactorY
                });
                obj.setCoords();
            });

            canvas.renderAll();
        }, 200); // Kleine Verzögerung für Rendering
    }, { crossOrigin: "anonymous" });
}      
       

document.getElementById("exportBtn").addEventListener("click", function() {
    exportCanvasAsPNG();
});

// 🔹 Entferne den doppelten Event Listener für den Export-Button
document.getElementById("exportBtn").removeEventListener("click", exportCanvasAsPNG);

function updateVariables() {
    // 1️⃣ Neue Werte aus den Eingabefeldern übernehmen
    apiVariables.name1 = document.getElementById("varName1").value;
    apiVariables.name2 = document.getElementById("varName2").value;
    apiVariables.weddingDate = document.getElementById("varWeddingDate").value;

    console.log("🔹 Aktualisierte Variablen:", apiVariables);

    // 2️⃣ JSON-Daten mit neuen Werten überschreiben
    layouts.forEach(layout => {
        layout.textGroups.forEach(group => {
            group.texts.forEach(t => {
                t.text = t.text
                    .replace(/name1/g, apiVariables.name1)
                    .replace(/name2/g, apiVariables.name2)
                    .replace(/weddingDate/g, apiVariables.weddingDate);
            });
        });
    });

    // 3️⃣ Text direkt im Canvas aktualisieren, ohne das Layout neu zu laden
    updateCanvasText();
}

function updateInputFields() {
    const name1Input = document.getElementById("varName1");
    const name2Input = document.getElementById("varName2");
    const dateInput = document.getElementById("varWeddingDate");

    name1Input.value = apiVariables.name1 || "";
    name2Input.value = apiVariables.name2 || "";
    dateInput.value = apiVariables.weddingDate || "";

    // ✨ CSS-Highlight-Klasse hinzufügen und automatisch wieder entfernen
    [name1Input, name2Input, dateInput].forEach(input => {
        input.classList.add("updated");
        setTimeout(() => {
            input.classList.remove("updated");
        }, 1000); // Dauer der Animation
    });
}

function lockEditor(message) {
    // Sperrt die Bearbeitung des Canvas
    canvas.selection = false;
    canvas.forEachObject(obj => obj.selectable = false);
    
    // Zeigt eine Nachricht an
    const lockMessage = document.createElement("div");
    lockMessage.id = "lockMessage";
    lockMessage.innerHTML = `<p>${message}</p>`;
    lockMessage.style.position = "absolute";
    lockMessage.style.top = "50%";
    lockMessage.style.left = "50%";
    lockMessage.style.transform = "translate(-50%, -50%)";
    lockMessage.style.background = "rgba(255, 0, 0, 0.8)";
    lockMessage.style.color = "white";
    lockMessage.style.padding = "15px";
    lockMessage.style.borderRadius = "8px";
    lockMessage.style.fontSize = "18px";
    lockMessage.style.zIndex = "1000";
    document.body.appendChild(lockMessage);
}

function checkLayoutID() {
    const urlParams = new URLSearchParams(window.location.search);
    const layoutId = urlParams.get("id");

    if (!layoutId) {
        console.warn("❌ Keine gültige Layout-ID gefunden!");
        lockEditor("Fehler: Keine gültige Layout-ID gefunden. Bitte verwenden Sie einen gültigen Link.");
        return null;
    }

    return layoutId;
}

function saveTemporaryLayout() {
    if (isProgrammaticLayoutChange) {
        console.log("🚫 Layout-Wechsel erkannt – temporäre Speicherung übersprungen.");
        return;
    }

    const layoutId = document.getElementById("layoutSelector").value;
    const layout = layouts.find(l => l.id == layoutId);
    if (!layout) return;

    const canvasData = canvas.toJSON();
    const dataToStore = {
        format: layout.format,
        data: canvasData
    };

    const storedRaw = sessionStorage.getItem(`custom_layout_${layoutId}`);
    const storedParsed = storedRaw ? JSON.parse(storedRaw) : null;

    // Nur speichern, wenn sich etwas verändert hat
    if (!storedParsed || JSON.stringify(storedParsed.data) !== JSON.stringify(canvasData)) {
        sessionStorage.setItem(`custom_layout_${layoutId}`, JSON.stringify(dataToStore));
        console.log(`💾 Layout ${layoutId} temporär gespeichert (mit Format: ${layout.format})`);
        updateDropdownStyles();
    }
}

</script>
</body>
</html>
